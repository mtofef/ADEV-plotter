import numpy as np
import matplotlib.pyplot as plt

def calculate_allan_deviation(data, max_tau_factor=0.25):
    """
    Calculates the Allan Deviation (ADEV) for a given data series.
    The data is assumed to be phase data.
    """
    n = len(data)
    # The maximum tau is set to a fraction of the data length for stability.
    max_tau_idx = int(n * max_tau_factor)
    tau_values = np.arange(1, max_tau_idx + 1)
    adev_values = np.zeros(len(tau_values))
    
    for i, m in enumerate(tau_values):
        # Calculate the cluster variance
        cluster_var = np.mean((data[2*m:] - 2*data[m:-m] + data[:-2*m])**2) / (2 * m**2)
        adev_values[i] = np.sqrt(cluster_var)

    return tau_values, adev_values

def calculate_time_deviation(tau_values, adev_values):
    """
    Calculates the Time Deviation (TDEV) from ADEV and tau values.
    TDEV($\tau$) = $\frac{\tau}{\sqrt{3}} \cdot$ ADEV($\tau$)
    """
    tdev_values = (tau_values / np.sqrt(3)) * adev_values
    return tdev_values

# --- Generate sample data ---
# Sample data of errors based on white noise and flicker noise
np.random.seed(42)
num_samples = 10000
white_noise = np.random.randn(num_samples) * 0.1
flicker_noise = np.cumsum(np.random.randn(num_samples)) * 0.05
phase_data = white_noise + flicker_noise

# --- Calculate ADEV and TDEV ---
tau_adev, adev = calculate_allan_deviation(phase_data)
tdev = calculate_time_deviation(tau_adev, adev)

# --- Create plots in a single figure ---
plt.style.use('seaborn-v0_8-darkgrid')
fig, (ax1, ax2) = plt.subplots(2, 1, figsize=(10, 12))
fig.suptitle('Allan Deviation (ADEV) & Time Deviation (TDEV)', fontsize=16)

# ADEV plot
ax1.loglog(tau_adev, adev, 'o-', color='teal', label='Allan Deviation')
ax1.set_title('Allan Deviation (ADEV)', fontsize=14)
ax1.set_xlabel('Observation Interval, $\\tau$ (s)')
ax1.set_ylabel('ADEV($\\tau$)')
ax1.legend()
ax1.grid(True, which="both", ls="-")

# TDEV plot
ax2.loglog(tau_adev, tdev, 'o-', color='purple', label='Time Deviation')
ax2.set_title('Time Deviation (TDEV)', fontsize=14)
ax2.set_xlabel('Observation Interval, $\\tau$ (s)')
ax2.set_ylabel('TDEV($\\tau$)')
ax2.legend()
ax2.grid(True, which="both", ls="-")

plt.tight_layout(rect=[0, 0, 1, 0.96])
plt.show()
